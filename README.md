# jmtp-client-go

JMTP 协议 client golang 实现版  

## Packet
---

``` text
+-------------+------+-----------+----------------------------------------------------+
| Name        | Code | Direction | Description                                        |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | 0    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| CONNECT     | 1    | C->S      | client connect to server                           |
+-------------+------+-----------+----------------------------------------------------+
| CONNECT_ACK | 2    | S->C      | channel connect acknowledge                        |
+-------------+------+-----------+----------------------------------------------------+
| PING        | 3    | C->S      | client send heartbeat packet to keep channel alive |
+-------------+------+-----------+----------------------------------------------------+
| PONG        | 4    | S->C      | heartbeat packet acknowledge                       |
+-------------+------+-----------+----------------------------------------------------+
| DISCONNECT  | 5    | S->C      | server disconnect channel                          |
+-------------+------+-----------+----------------------------------------------------+
| REPORT      | 6    | C->S      | client report monitor data                         |
+-------------+------+-----------+----------------------------------------------------+
| REPORT_ACK  | 7    | S->C      | report acknowledge (high QoS only)                 |
+-------------+------+-----------+----------------------------------------------------+
| COMMAND     | 8    | S->C      | server send command packet to client               |
+-------------+------+-----------+----------------------------------------------------+
| COMMAND_ACK | 9    | C->S      | command acknowledge                                |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | A    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | B    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | C    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | D    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | E    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
| Reserved    | F    | None      | None                                               |
+-------------+------+-----------+----------------------------------------------------+
```

### CONNECT
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x1)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PROTOCOL NAME (JMTP)                         |--> @tiny-varchar
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PROTOCOL VERSION (1 byte)                    |--> utiny (0-255)
+-----+-----+-----+-----+-----+-----+-----+-----+
|  HEARTBEAT SECOUNDS (1-2 byte)                |--> vushort (0-16383)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  SERIALIZE TYPE                               |--> @vushort
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  ApplicationId (4 byte)                       |--> int32
+                                               +
|                                               |
+                                               +
|                                               |
+                                               +
|                                               |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  InstanceId (4 byte)                          |--> int32
+                                               +
|                                               |
+                                               +
|                                               |
+                                               +
|                                               |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAGS                                         |--> @tiny-map
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```

### CONNECT_ACK
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x2)   |  Reserved |RETRY| RDT |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  ACK CODE (1-4 byte)                          |--> vuint [0 = success]
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [ACK MESSAGE]                                |--> @short-varchar
~                                               ~  > # Only exists if ACK_CODE is not 0
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [RETRY SECOUNDS] (1-2 byte)                  |--> vushort (0-16383)
~                                               ~  > # Only exists if ACK_CODE is not 0 AND RETRY flag is 1
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [REDIRECT URL]                               |--> @short-varchar
~                                               ~  > # Only exists if RDT flag is 1
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### PING
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x3)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### PONG
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x4)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### DISCONNECT
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x5)   |  Reserved       | RDT |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  DISCONNECT CODE (1-4 byte)                   |--> vuint [0 = success]
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  DISCONNECT MESSAGE                           |--> @short-varchar
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [REDIRECT URL]                               |--> @short-varchar
~                                               ~  > # Only exists if RDT flag is 1
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### REPORT
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x6)   |  Reserved | SS  | QoS |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [PACKET_ID]                                  |--> @tiny-bytes
~                                               ~  > # Only exists if QoS flag is 1
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [SPECIFIC_SERIALIZE_TYPE]                    |--> @vushort
~                                               ~  > # Only exists if SS flag is 1
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REPORT_TYPE (1-2 byte)                       |--> vushort (0-16383)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PAYLOAD                                      |--> bytes until packet's end
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### REPORT_ACK
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x7)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKET_ID                                    |--> @tiny-bytes
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  ACK CODE (1-4 byte)                          |--> vuint [0 = success]
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [ACK MESSAGE]                                |--> @short-varchar
~                                               ~  > # Only exists if ACK_CODE is not 0
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### COMMAND
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x8)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKET_ID                                    |--> @tiny-bytes
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  COMMAND                                      |--> @short-varchar
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PAYLOAD                                      |--> bytes until packet's end
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### COMMAND_ACK
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKAGE TYPE (0x9)   |  Reserved             |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CRC CODE (1 byte)                            |--> byte
+-----+-----+-----+-----+-----+-----+-----+-----+
|  REMAINING LENGTH (1-4 byte)                  |--> vuint (0-268435455)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PACKET_ID                                    |--> @tiny-bytes
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  ACK CODE (1-4 byte)                          |--> vuint [0 = success]
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  [ACK MESSAGE]                                |--> @short-varchar
~                                               ~  > # Only exists if ACK_CODE is not 0
+-----+-----+-----+-----+-----+-----+-----+-----+
|  PAYLOAD                                      |--> bytes until packet's end
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


## Packet Structure
----

### @tiny-varchar / @tiny-bytes (1-256 byte)
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CONTENT LENGTH (1 byte)                      |--> utiny (0-255)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CONTENT (0-255 byte)                         |--> content bytes (utf-8)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### @short-varchar / @short-bytes (1-16385 byte)
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CONTENT LENGTH (1-2 byte)                    |--> vushort (0-16383)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  CONTENT (0-16383 byte)                       |--> content bytes (utf-8)
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### @short-kv-pair (2-32770 byte)
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  KEY                                          |--> @short-varchar
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  VALUE                                        |--> @short-varchar / @short-bytes
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


### @tiny-map (1-8356351 byte)
``` text
|  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAGS COUNT (1 byte)                          |--> utiny (0-255)
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAG 1                                        |--> @short-kv-pair
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAG 2                                        |--> @short-kv-pair
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAG ...                                      |--> @short-kv-pair
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
|  TAG N                                        |--> @short-kv-pair
~                                               ~
+-----+-----+-----+-----+-----+-----+-----+-----+
```


## Algorithm
----

### variable unsigned integer

| Digits | From                               | To                                   | Type    |
|--------|------------------------------------|--------------------------------------|---------|
| 1      | 0 (0x00)                           | 127 (0x7F)                           |         |
| 2      | 128 (0x80, 0x01)                   | 16 383 (0xFF, 0x7F)                  | vushort |
| 3      | 16 384 (0x80, 0x80, 0x01)          | 2 097 151 (0xFF, 0xFF, 0x7F)         |         |
| 4      | 2 097 152 (0x80, 0x80, 0x80, 0x01) | 268 435 455 (0xFF, 0xFF, 0xFF, 0x7F) | vuint   |

#### Encodding

The algorithm for encoding a non negative integer (X) into the variable length encoding scheme is as follows:

```
do

    encodedByte = X MOD 128

    X = X DIV 128

    // if there are more data to encode, set the top bit of this byte

    if ( X > 0 )

        encodedByte = encodedByte OR 128

    endif

        'output' encodedByte

while ( X > 0 )
```
 
Where MOD is the modulo operator (% in C), DIV is integer division (/ in C), and OR is bit-wise or (| in C).

 

#### Decoding

The algorithm for decoding the Remaining Length field is as follows:

```
multiplier = 1

value = 0

do

    encodedByte = 'next byte from stream'

    value += (encodedByte AND 127) * multiplier

    multiplier *= 128

    if (multiplier > 128*128*128)

        throw Error(Malformed Remaining Length)

while ((encodedByte AND 128) != 0)

```
 
where AND is the bit-wise and operator (& in C).

When this algorithm terminates, value contains the Remaining Length value.